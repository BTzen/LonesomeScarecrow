<!-- KILLER CUTS 2015, comin to ya live! -->

<!DOCTYPE html>
<html>

<head>
  <title>Chess</title>
   
<!-- <<<<<<< Updated upstream -->
   <link rel="stylesheet" type="text/css" href="chessboardStyle.css">
	 <link rel="stylesheet" href="jquery-ui/jquery-ui.css">
	 <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> <!--for crossbrowser compatibility-->
   <script src="jquery-ui/external/jquery/jquery.js"></script>
	 <script type="text/javascript" src="piece.js"></script>
   <script type="text/javascript" src="pieceListeners.js"></script>
   <script type="text/javascript" src="minimax.js"></script>
   <script type="text/javascript" src="ai.js"></script>
   <script type="text/javascript" src="chessboardScript.js" ></script>
<!-- =======
	<link rel="stylesheet" type="text/css" href="chessboardStyle.css">
	<link rel="stylesheet" href="jquery-ui/jquery-ui.css">
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> --> <!--for crossbrowser compatibility-->
<!-- 	<script src="jquery-ui/external/jquery/jquery.js"></script>
	<script src="jquery-ui/jquery-ui.js"></script>
	<script type="text/javascript" src="piece.js"></script>
	<script type="text/javascript" src="pieceListeners.js"></script>
	<script type="text/javascript" src="ai.js"></script>
	<script type="text/javascript" src="chessboardScript.js" ></script>
	<script type="text/javascript" src="minimax.js"></script>	<!-- FOR TESTING PURPOSES 
>>>>>>> Stashed changes -->
</head>

<body>
	<div id="gameArea">
	
		
		<h3 id="turn">Turn: White</h3>
		<div id="fileNotation">
			ABCDEFGH
		</div>
		<div id="rankNotation">
			87654321
		</div>
		<div id="boardAndInfo">
			
			<fieldset id="gameInfo">
				<legend>Options</legend>
				<label>Select ply: </label><input type="number" id="uiPly" min="1" max="4" value="3">
				<input type="button" class="uiSurrender fill" value="Surrender" onclick="surrenderListener()" disabled>
				<input type="button" class="uiStart" value="Start" onclick="startMatchEvent()">
				<input type="button" id="uiFreeplay" value="Freeplay" onclick="freeplayListener()">
			</fieldset>
			<fieldset id="freeplayInfo">
				<legend>Freeplay</legend>
				<input id="fpAddPiece" type="button" value="Add" 
					onclick="addPiece($('select[name=fpIsWhite]').val(), $('select[name=fpPiece]').val(), $('select[name=fpRank]').val(), $('select[name=fpFile]').val())">
				<select id="fpIsWhite" name="fpIsWhite">
					<option value="true">White</option>
					<option value="false">Black</option>
				</select>
				<select id="fpPiece" name="fpPiece">
					<option value="Pawn">Pawn</option>
					<option value="Rook">Rook</option>
					<option value="Knight">Knight</option>
					<option value="Bishop">Bishop</option>
					<option value="Queen">Queen</option>
					<option value="King">King</option>
				</select>
				at
				<select name="fpFile">
					<option value="0">a</option>
					<option value="1">b</option>
					<option value="2">c</option>
					<option value="3">d</option>
					<option value="4">e</option>
					<option value="5">f</option>
					<option value="6">g</option>
					<option value="7">h</option>
				</select>
				<select name="fpRank">
					<option value="7">1</option>
					<option value="6">2</option>
					<option value="5">3</option>
					<option value="4">4</option>
					<option value="3">5</option>
					<option value="2">6</option>
					<option value="1">7</option>
					<option value="0">8</option>
				</select>
				
				<div id="freeplayPieces">
					<ol>
					</ol>
				</div>
				<input type="button" class="uiStart fill" value="Start" onclick="startMatchEvent()">
				<input type="button" class="uiSurrender fill" value="Surrender" onclick="surrenderListener()" disabled>
				<input type="button" class="fill alignBottom" value="Exit Freeplay" onclick="exitFreeplayListener()">
			</fieldset>
			
			<div id="board">
				<canvas id="chessboard" width="600" height="600"></canvas>
				<canvas id="highlight" width="600" height="600"></canvas>
				<canvas id="chesspieces" width="600" height="600"></canvas>
			</div>
		</div>
	</div>
	
	<div id="promotion">
		<label>&#9819;&#9820;&#9821;&#9822;</label>
		<div id="promoteOptions">
			<input type="radio" name="promotionPick" value="Queen">Queen
			<input type="radio" name="promotionPick" value="Rook">Rook
			<input type="radio" name="promotionPick" value="Bishop">Bishop
			<input type="radio" name="promotionPick" value="Knight">Knight
		</div>
		<input type="button" id="acceptPromotion" value="Accept" onclick="acceptPromotionListener()">
	</div>
	<script>
		var listitemID = 1;	//so the remove button knows what list element to delete
		var occupiedTiles = [];
		var isWhiteKingPlaced = false;
		var isBlackKingPlaced = false;
		var whiteKingData = [];
		var blackKingData = [];
		
		// TESTING STUFF
		//isGameRunning = true;
		/*placePieces(true);
		var board1 = jQuery.extend(true, {}, board);
		console.log(board1 === board);
		board1.__position__[38] = new King(true);
		console.log(board1 === board);
		changeboard(board);
		changeboard(board1);
		
		function changeboard(board) {
			var board2 = jQuery.extend(true, {}, board);
			board2.__position__[39] = new Queen(false);
		}*/
		// GAMEPLAY
		/*
		 *
		*/
		function acceptPromotionListener() {
			var newPiece;
			var isWhite = $('#promotion').data('isWhite');
			var row = $('#promotion').data('row');
			var col = $('#promotion').data('column');
			board.removePiece(row, col);
			//alert($('#promotion').data('isWhite') + ' ' + $('#promotion').data('row') + ' ' + $('#promotion').data('column'));
			switch ($('input[name=promotionPick]:checked').val()) {
				case "Queen":
					newPiece = new Queen(isWhite, row, col);
					break;
				case "Rook":
					newPiece = new Rook(isWhite, row, col);
					break;
				case "Bishop":
					newPiece = new Bishop(isWhite, row, col);
					break;
				case "Knight":
					newPiece = new Knight(isWhite, row, col);
					break;
			}
			
			board.placePiece(newPiece, row, col);
			$('#promotion').dialog("close");	//close dialog
		}
		
		/* Add piece to board for freeplay
		 * May not need to have isKingPlaced
		*/
		function addPiece(isWhite, pieceName, rank, file) {
			var row = parseInt(rank);
			var col = parseInt(file);
			var color = isWhite == "true";
			var piece;
			
			//for adding piece to the div
			var file = $('select[name=fpFile] option:selected').text();
			var rank = $('select[name=fpRank] option:selected').text();
			
			//add piece to board and backing data structure
			switch (pieceName) {
				case "Pawn":
					piece = new Pawn(color);
					break;
				case "Rook":
					piece = new Rook(color);
					break;
				case "Knight":
					piece = new Knight(color);
					break;
				case "Bishop":
					piece = new Bishop(color);
					break;
				case "Queen":
					piece = new Queen(color);
					break;
				case "King":
					piece = new King(color);
					if (color) {
						if (isWhiteKingPlaced) {
							board.removePiece(whiteKingData[1], whiteKingData[2]);	//remove old king from board
							removePiece(whiteKingData[0], file + rank);	//remove old king from list
						}
					
						isWhiteKingPlaced = true;
						whiteKingData = [listitemID, row, col];	
					}
					else {
						if (isBlackKingPlaced) {
							board.removePiece(blackKingData[1], blackKingData[2]);	//remove old king from board
							removePiece(blackKingData[0], file + rank);	//remove old king from list
						}
						isBlackKingPlaced = true;
						blackKingData = [listitemID, row, col];	
					}
					break;
			}
			
			//make sure there's only 1 list entry per tile (eg. there can't be 2 different pieces at 'a1' simulataneously)
			var tileIndex = -1;	//store index of the list item that's currently in the desired position
			for (var i = 0; i < occupiedTiles.length; i++) { //mimic behaviour of .indexOf method, since that method doesn't work for complex arrays
				if (occupiedTiles[i][1] == (file + rank))	{
					tileIndex = i; 
					break;
				}
			}
			if (tileIndex != -1) {	//may have compatibility issues with older browsers
				removePiece(occupiedTiles[tileIndex][0], occupiedTiles[tileIndex][1]); //remove the old piece and replace the list item currently at that position with the new 1
				occupiedTiles.splice(tileIndex,1);	//remove item from array at that index
				
				//make the appropriate changes if the new piece is booting out a king
				if (whiteKingData != null && whiteKingData[1] == row && whiteKingData[2] == col) {
					isWhiteKingPlaced = false;
					whiteKingData = null;
				}
				if (blackKingData != null && blackKingData[1] == row && blackKingData[2] == col) {
					isBlackKingPlaced = false;
					blackKingData = null;
				}
			}
			occupiedTiles.push([listitemID, file + rank, pieceName]);		//add the element to the occupiedTiles list
			//console.log(listitemID + ', ' + (file + rank) + ', ' + pieceName); //debug
			board.placePiece(piece, row, col);	//overwrite the old piece if the user attempts to place another piece on an already occupied tile
			
			//append new entry to list
			$('#freeplayPieces ol').append('<li>' + String.fromCharCode(piece.unicode) + ' ' + 
				file + rank + ' ' + '<input id="freeplayEntry' + listitemID + '" type="button" value="Remove" onclick="removePiece(' + listitemID + ', \'' + file + rank + '\')"></li>'); 
				/*alert('<input id="freeplayEntry' + listitemID + '" type="button" value="Remove" onclick="removePiece(' + listitemID++ + ', \'' + file + rank + '\')">');*/
			listitemID++;
		}
		
		/* Remove piece from board and from backing data structure
		*/
		function removePiece(entryID, fileRankString) {
			/*alert(entryID + ' ' + fileRankString);*/
			var row = (8 - parseInt(fileRankString.substring(1,2)));
			var col = parseInt(fileRankString.charCodeAt(0)) - 97; //97 reduces value of a to 0
			board.removePiece(row, col);	//doesn't do anything if there isn't a piece at that location
			
			//remove piece from occupied tile list
			for (var i = 0; i < occupiedTiles.length; i++) {
				if (occupiedTiles[i][0] == entryID) {
					occupiedTiles.splice(i,1);
				}
			}
			$('#freeplayEntry' + entryID).parent().remove();	//delete list item
		}
		
		function startMatchEvent() {
			startAI();
			if (isGameRunning) {
				placePieces(true);
				//$('#turn').css('visibility', 'visible');
				$('#uiFreeplay').attr('disabled', true);
			}
		}
		
		function surrenderListener() {
			if (isGameRunning) {
				//reset board to initial state
				isGameRunning = false; alert("You're a loser!");
				$('#uiFreeplay').attr('disabled', false);
				$('.uiSurrender').attr('disabled', true);
				$('.uiStart').attr('disabled', false);
				document.getElementById('#highlight').getContext('2d').clearRect(0,0, 8 * LENGTH, 8 * LENGTH);
				reinit(true);  // CALL ON START INSTEAD IN CASE AI SURRENDERS?!?!
			}
			else {
				alert("You can't give up if you haven't even started yet!");
			}
		}
		/* doesn't currently stop the game
		*/
		function freeplayListener() {
			// hide normal fieldset and show the one for freeplay
			$('#gameInfo').css('display', 'none');
			$('#freeplayInfo').css('display', 'initial');
			
			// handle switching changes (ie. clear board, stop AI, etc.)
			$('#turn').prop('display', 'none');
			
			board.clear(0, 0, 8, 8);
		}
		
		function exitFreeplayListener() {
			// hide freeplay fieldset and show the std one
			$('#freeplayInfo').css('display', 'none');
			$('#gameInfo').css('display', 'initial');
			
			//clear board
			board.clear(0, 0, 8, 8);
			
			$('#turn').css('visibility', 'hidden');
		}
		/* changes UI and gameRunning bool
		 * 
		*/
		function startAI() {
			isGameRunning = true;
			$('#turn').css('visibility', 'visible');
			$('.uiSurrender').attr('disabled', false);
			$('.uiStart').attr('disabled', true);
			//alert("The match has started!");
		}
	</script>
	<script>
	/*
		var newBoard = jQuery.extend(true, {}, board);
		var test = maxi(Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,2,newBoard);
		//var test = mini(2);
		//console.log(nodeCount);
		console.log("Final Value: " + test);
		*/
	</script>
</body>

</html>